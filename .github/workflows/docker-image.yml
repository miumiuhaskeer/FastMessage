# Need to upload new version to Docker after git push
name: Docker Image CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:

  build:

    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3
    - name: Setup Java JDK 8
      uses: actions/setup-java@v1
      with:
        java-version: 8
    - name: Cache Maven packages
      uses: actions/cache@v2
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    - name: Run tests with Maven
      run: mvn package
    - name: Docker meta
      id: meta
      uses: crazy-max/ghaction-docker-meta@v2
      with:
        images: heybitbro/fast-message
        tags: |
          type=raw,value=latest,enable=${{ endsWith(GitHub.ref, 'master') }}
          type=ref,event=tag
        flavor: |
          latest=false
    - name: Login to DockerHub
      if: GitHub.event_name != 'pull_request'
      uses: docker/login-action@v2.0.0
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - name: Docker compose build
      if: GitHub.event_name != 'pull_request'
      run: docker-compose build --no-cache
    - name: Docker compose tag
      if: GitHub.event_name != 'pull_request'
      run: docker-compose tag heybitbro/fast-message
    - name: Docker compose push
      if: GitHub.event_name != 'pull_request'
      run: docker-compose push heybitbro/fast-message
#    - name: Build and push
#      uses: docker/build-push-action@v3.0.0
#      with:
#        context: .
#        push: ${{ GitHub.event_name != 'pull_request' }}
#        tags: ${{ steps.meta.outputs.tags }}
#        labels: ${{ steps.meta.outputs.labels }}
